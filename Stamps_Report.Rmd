---
title: "Stamps Report"
author: "Alberto Castillo"
date: "5/31/2018"
output: html_document
---

```{r include=FALSE}
library(tidyverse)
library(dplyr)
library(tidyquant)
options(scipen=999)
options(tibble.width = Inf)
options(tibble.height = Inf)

Purchase_Data <- readxl::read_excel("2018-03-12 Stamps.com Excel assessment.xlsx", 
                            sheet = "Purchase Payment Data")
Purchase_Data$Date <- as.Date(Purchase_Data$Date, format = '%m/%d/%Y')
Purchase_Data <- Purchase_Data %>%
  mutate(month = format(Date, "%m"),
         day_of_week = wday((Date), label = TRUE))
January_Billing_Cycle <- Purchase_Data[Purchase_Data$Date >= "2017-01-16" & Purchase_Data$Date <= "2017-02-15",]
January_Billing_Cycle <- January_Billing_Cycle %>%
                          group_by(Company) %>%
                          summarise(January = sum(Spend, na.rm = TRUE))
#February's Billing Cycle
February_Billing_Cycle <- Purchase_Data[Purchase_Data$Date >= "2017-02-16" & Purchase_Data$Date <= "2017-03-15",]
February_Billing_Cycle <- February_Billing_Cycle %>%
                          group_by(Company) %>%
                          summarise(February = sum(Spend, na.rm = TRUE))
#March's Billing Cycle
March_Billing_Cycle <- Purchase_Data[Purchase_Data$Date >= "2017-03-16" & Purchase_Data$Date <= "2017-04-15",]
March_Billing_Cycle <- March_Billing_Cycle %>%
                        group_by(Company) %>%
                        summarise(March = sum(Spend, na.rm = TRUE))
#April's Billing Cycle
April_Billing_Cycle <- Purchase_Data[Purchase_Data$Date >= "2017-04-16" & Purchase_Data$Date <= "2017-05-15",]
April_Billing_Cycle <- April_Billing_Cycle %>%
                        group_by(Company) %>%
                        summarise(April = sum(Spend, na.rm = TRUE))
#May's Billing Cycle
May_Billing_Cycle <- Purchase_Data[Purchase_Data$Date >= "2017-05-16" & Purchase_Data$Date <= "2017-06-15",]
May_Billing_Cycle <- May_Billing_Cycle %>%
                      group_by(Company) %>%
                      summarise(May = sum(Spend, na.rm = TRUE))
#June's Billing Cycle
June_Billing_Cycle <- Purchase_Data[Purchase_Data$Date >= "2017-06-16" & Purchase_Data$Date <= "2017-07-15",]
June_Billing_Cycle <- June_Billing_Cycle %>%
                      group_by(Company) %>%
                      summarise(June = sum(Spend, na.rm = TRUE))
#July's Billing Cycle
July_Billing_Cycle <- Purchase_Data[Purchase_Data$Date >= "2017-07-16" & Purchase_Data$Date <= "2017-08-15",]
July_Billing_Cycle <- July_Billing_Cycle %>%
                      group_by(Company) %>%
                      summarise(July = sum(Spend, na.rm = TRUE))
#August's BIlling Cycle
August_Billing_Cycle <- Purchase_Data[Purchase_Data$Date >= "2017-08-16" & Purchase_Data$Date <= "2017-09-15",]
August_Billing_Cycle <- August_Billing_Cycle %>%
                        group_by(Company) %>%
                        summarise(August = sum(Spend, na.rm = TRUE))
#September's Billing Cycle
September_Billing_Cycle <- Purchase_Data[Purchase_Data$Date >= "2017-09-16" & Purchase_Data$Date <= "2017-10-15",]
September_Billing_Cycle <- September_Billing_Cycle %>%
                            group_by(Company) %>%
                            summarise(September = sum(Spend, na.rm = TRUE))
#October's Billing Cycle
October_Billing_Cycle <- Purchase_Data[Purchase_Data$Date >= "2017-10-16" & Purchase_Data$Date <= "2017-11-15",]
October_Billing_Cycle <- October_Billing_Cycle %>%
                          group_by(Company) %>%
                          summarise(October = sum(Spend, na.rm = TRUE))
#November's Billing Cycle
November_Billing_Cycle <- Purchase_Data[Purchase_Data$Date >= "2017-11-16" & Purchase_Data$Date <= "2017-12-15",]
November_Billing_Cycle <- November_Billing_Cycle %>%
                          group_by(Company) %>%
                          summarise(November = sum(Spend, na.rm = TRUE))
```


## Show total amount of purchases in each month by each company 
Here we create a stacked bar graph to visualize how many purchases occured by every month for each company.
We can clearly the the numbers in white for each customer. The stacked bar graph is in order exactly like the legend so as you move down each square you would follow along with the legend.
```{r fig.width=10, fig.height=6}
Purchase_Data %>%
  ggplot(aes(x = format(Date, "%Y-%m"), fill = Company))+
  geom_bar(color = 'Black') +
  labs(x = 'Month', y = "Count of Purchases by Month", title = "How many Purchases by Companies every Month")+
  geom_text(stat = 'count', aes(label=..count..), size = 3, position = position_stack(vjust = 0.5), color="white")
  
```

## Billing for each Company at the end of the month. This is the largest bill that Stamps will collect in the entire year
We want find the value of our bills we need to charge at the end of each month. The bill is calculated at the sum of the purchases a company creates minus the value of the payment they made in the same period.
In our data payments are denoted as (-) so in our data we do an addition.
Finally we want to see what the maximum amout of money we will collect in this year will be.
```{r}
Bill_Data <- Purchase_Data %>%
  group_by(month, Company) %>%
  summarise(sum_spend = sum(Spend, na.rm = TRUE), sum_payment = sum(Payment, na.rm = TRUE), Bill = sum_spend + sum_payment)
max(Bill_Data$Bill) 
```
## What is the dollar amount of each customers highest bill
Now we want to see what is the dollar amount of the higest bill for each customer. This is the amount of money that each company owes. 
```{r}
Bill_Data %>%
  group_by(Company) %>%
  summarise(max_bill = max(Bill)) 
```


## Profit margins is a flat percentage. 1st, 4th, 6th profitable person
Now we want to see which companies are the most profitable for us. So we look at the total amount of purchases that is made by each specific company. Then we order them from the largest total purchase to the smallest and return the values we are looking for: The most profitable companies.
```{r}
Profitable_margin_customers <- Purchase_Data %>%
  group_by(Company) %>%
  summarise(total_purchase = sum(Spend, na.rm = TRUE)) %>%
  arrange(desc(total_purchase))
Profitable_margin_customers[1,]
Profitable_margin_customers[4,]
Profitable_margin_customers[6,]
```


## Credit Exposure
Since most companies are not paying their entire orders in one payment, but have spread them out over an amount of time. We need to determine what our exposure is, that is, how much would we be in debt if our customers suddenly went bankrupt. We can see that some months we are (-) which means that these months companies made enough payments to push us into cash flow positive territory.
```{r}
Bill_Data %>%
  group_by(month) %>%
  summarise(credit_exposure = sum(Bill))
```

## Most Valueable Customer YTD. If we go off the same as in question 4 and choose 1, 4, 6
We have looked at the most valueable customer when it comes to the total amount of purchases made, but now we are looking for the most valueable customers that are making the most payments on their purchases.
```{r}
Customer_Payments <- Purchase_Data %>%
  group_by(Company) %>%
  summarise(total_payments = sum(Payment, na.rm = TRUE)) %>%
  arrange(total_payments)
Customer_Payments[1,]
Customer_Payments[4,]
Customer_Payments[6,]
```

## The Highest Payments Per Month by each Company
We can break down our information of payments to look at who is making the highest payment by month.
```{r}
Customer_Payments_month1 <- Purchase_Data %>%
  group_by(Company, month) %>%
  summarise(total_payments = sum(Payment, na.rm = TRUE)) %>%
  group_by(month) %>%
  summarise(total_payments = min(total_payments))
Customer_Payments_month2 <- Purchase_Data %>%
  group_by(Company, month) %>%
  summarise(total_payments = sum(Payment, na.rm = TRUE))
Customer_Payments_month <- left_join(Customer_Payments_month1, Customer_Payments_month2, by = c('month', 'total_payments'))

Customer_Payments_month
```

## Total Amount of Purchases by each Company for each Billing Cycle
Here we want to see what the total amount of purchases in dollar value is for each company in the billing cycle beginning on the 16th of every month and ending on the 15th.
```{r }
Billing_Cycle <- left_join(January_Billing_Cycle, February_Billing_Cycle, by='Company') %>%
  left_join(., March_Billing_Cycle, by = "Company") %>%
  left_join(., April_Billing_Cycle, by='Company') %>%
  left_join(., May_Billing_Cycle, by = "Company") %>%
  left_join(., June_Billing_Cycle, by = 'Company') %>%
  left_join(., July_Billing_Cycle, by= 'Company') %>%
  left_join(., August_Billing_Cycle, by = "Company") %>%
  left_join(., September_Billing_Cycle, by = "Company") %>%
  left_join(., October_Billing_Cycle, by = "Company") %>%
  left_join(., November_Billing_Cycle, by = "Company")
Billing_Cycle
```

## Visualizing our Data
Here we want to see how the purchases of all the companies look across the entire year of 2017.
Plotting each respective company we can go ahead and smooth out the data to see if we can determine
any form of trend by each company. This will be a start for our machine learning to come for the forecasting
of the year of 2018 by each company.

```{r fig.width= 10, fig.height= 20}
Purchase_Data %>%
  ggplot(aes(x = Date, y = Spend, group = 1))+
  facet_wrap(~ Company, ncol = 2, scales = 'free')+
  geom_point(aes(color = day_of_week), na.rm = TRUE)+
  geom_line(na.rm = TRUE, show.legend = FALSE, color = palette_light()[[1]], alpha = 0.8)+
  geom_smooth(na.rm = TRUE, color = 'blue')+
  scale_color_manual(values = palette_light())+
  theme_tq()+
  labs(color = "Days of the Week", title = "Purchases From The Entire Year by each Company", x = 'Days')
```



